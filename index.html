<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./style/style.css">
    <title>Dithering</title>
</head>
<body>
    <select name="picture" id="picture">
        <option value="./texture/david.png">David</option>
        <option value="./texture/lenna.png">Lenna</option>
        <option value="./texture/einstein.jpg">Einstein</option>
    </select>

    <select name="mode" id="mode">
        <option value="0">Normal</option>
        <option value="1">Grayscale</option>
        <option value="2">Threshold</option>
        <option value="3">Random</option>
        <option value="4">Bayer</option>
    </select>

    <input type="file" id="file" accept="image/png, image/jpeg">

    <canvas id="canvas"></canvas>

    <script id="vertexShader" type="x-shader/x-vertex">#version 300 es

        in vec2 inPosition;

        uniform mat3 uMatrix;

        out vec2 texCoord;
         
        void main() {

            texCoord = inPosition;
            gl_Position = vec4(uMatrix * vec3(inPosition, 0.0), 1.0);
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">#version 300 es
        precision mediump float;

        in vec2 texCoord;

        uniform sampler2D tex;
        uniform int mode;

        const float indexM2x2[4] = float[4] (
            0.0, 2.0,
            3.0, 1.0
        );

        const int indexM3x3[9] = int[] (
            0, 7, 3,
            6, 5, 2,
            4, 1, 8
        );

        const int indexM4x4[16] = int[](
            0,  8,  2,  10,
            12, 4,  14, 6,
            3,  11, 1,  9,
            15, 7,  13, 5
        );

        const int indexM8x8[64] = int[](
             0, 32, 8, 40, 2, 34, 10, 42, 
            48, 16, 56, 24, 50, 18, 58, 26, 
            12, 44, 4, 36, 14, 46, 6, 38, 
            60, 28, 52, 20, 62, 30, 54, 22, 
             3, 35, 11, 43, 1, 33, 9, 41, 
            51, 19, 59, 27, 49, 17, 57, 25,
            15, 47, 7, 39, 13, 45, 5, 37,
            63, 31, 55, 23, 61, 29, 53, 21
        );

        const vec3 grayColor = vec3(0.299, 0.587, 0.114);

        out vec4 outColor;

        float random (vec2 vec) {
            return fract(sin(dot(vec.xy, vec2(12.9898, 78.233))) * 43758.5453123);
        }

        float grayscale () {
            vec4 col = texture(tex, texCoord);
            float gray = dot(col.rgb, grayColor);

            return gray;
        }

        float dither2(vec4 vec) {
            int x = int(mod(vec.x, 2.0));
            int y = int(mod(vec.y, 2.0));

            float arrVal = indexM2x2[(x + y * 2)] / 4.0;
            float val = vec.x;

            if(val > arrVal) {
                return 1.0 - indexM2x2[(x + y * 2)] / 4.0;
            } else {
                return indexM2x2[(x + y * 2)] / 4.0;
            }
        }
        
        void main() {
            vec4 color;

            if(mode == 0) {
                outColor = texture(tex, texCoord);

            } else if (mode == 1) {
                outColor = vec4(vec3(grayscale()), 1.0);

            } else if (mode == 2) {
                color = texture(tex, texCoord);
                float val = color.r;

                if(val > 0.45) {
                    outColor = vec4(1);
                } else {
                    outColor = vec4(0,0,0,1);
                }

            } else if (mode == 3) { // random
                color = texture(tex, texCoord);
                float pix = color.r;

                if(pix < random(texCoord)) {
                    outColor = vec4(0,0,0,1);
                } else {
                    outColor = vec4(1);
                }
                //outColor = texture(tex, texCoord) + color;//vec4(luminance,luminance,, 1.0);

            } else if (mode == 4) {
                float ditherColor = dither2(texture(tex, texCoord));
                outColor = vec4(vec3(ditherColor), 1.0);
            }

        }
    </script>
    
    <script src="program.js"></script>
    <script src="app.js"></script>
</body>
</html>